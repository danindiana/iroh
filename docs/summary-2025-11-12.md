# Summary: Local Relay + QAD Workflow and Fork Setup (2025-11-12)

This document captures what we accomplished to enable a smooth local relay + QUIC Address Discovery (QAD) workflow, and the fork-only strategy for ongoing iteration.

## Overview
- Set up and validated a local `iroh-relay` with QAD using a self-signed TLS cert (with proper SANs).
- Documented end-to-end steps and added troubleshooting guidance.
- Moved to a fork-only workflow and merged improvements into the fork’s `main` branch.
- Added CI/automation to maintain docs health and verify relay behavior on Linux.

## Key Outcomes
- Local relay + QAD runs reliably; logs confirm QAD probes.
- The fork has reproducible docs, helper scripts, CI checks, and a smoke test pipeline.
- Upstream PRs were closed intentionally—work is maintained in the fork.

## Notable Repository Changes (Fork)
- Documentation:
  - `docs/local-relay-dev.md`: End-to-end local relay + QAD guide.
  - Troubleshooting table added (symptoms, causes, resolutions).
  - `docs/README.md`: Documentation index (links to all relevant docs including fork notes).
  - `docs/fork-notes.md`: Fork rationale, sync strategy, future ideas.
  - `README.md`: Fork-Specific Additions section and sync instructions.
  - `CONTRIBUTING.md`: How to reproduce networking/relay issues locally for faster triage.
- Helper scripts:
  - `scripts/local-relay-setup.sh`: Generates certs (with SAN), relay config, and client config; idempotent (`--force` to regenerate).
  - `scripts/relay-smoke-test.sh`: Builds and runs the relay briefly; verifies ports 3340/7842/9090; logs to `tmp/relay-smoke.log`.
- CI and GitHub templates:
  - `.github/scripts/check-docs-index.sh`: Ensures every `docs/*.md` is referenced in `docs/README.md`.
  - `.github/workflows/docs-index-check.yml`: Runs the docs index checker on changes/PRs.
  - `.github/workflows/relay-smoke.yml`: Relay smoke workflow
    - Triggers: push, PR (relevant paths), and manual `workflow_dispatch`.
    - Matrix: `ubuntu-22.04`, `ubuntu-latest`, `macos-latest`, `windows-latest` × Rust `stable`, `beta`, `nightly`.
    - Nightly and non-Linux builds are `continue-on-error` for signal without blocking.
    - Linux: full smoke test; non-Linux: build-only.
    - On failures (Linux), upload `tmp/relay-smoke.log` as an artifact.
  - `.github/ISSUE_TEMPLATE/local-relay.md`: Structured template for local relay/QAD issues.

## Git Operations and Policy
- Fork-first policy: upstream PRs were closed; all changes are kept in `https://github.com/danindiana/iroh`.
- Merged feature branches into the fork’s `main`:
  - `docs/local-relay-link`: README link to local relay guide.
  - `docs/local-relay-followups`: Troubleshooting, setup script, docs index, contributing update.
- Set GitHub CLI default repo to the fork for future operations.

## Local Sanity Checks
- `cargo fmt` — PASS
- `cargo clippy` (workspace, all targets, all features, `-D warnings`) — PASS
- Docs index check script — PASS

## How to Use (Quick Pointers)
- Bootstrap local relay (certs + configs): `scripts/local-relay-setup.sh`
- Start relay (dev mode) and collect logs: follow `docs/local-relay-dev.md`
- Run smoke test locally: `scripts/relay-smoke-test.sh`
- Manually trigger CI smoke test (GitHub UI): Actions → Relay Smoke Test → Run workflow

## Optional Next Steps
- Upload entire `tmp/` folder as artifact on failures.
- Extend smoke test to macOS with Darwin-friendly port checks (e.g., `lsof`/`netstat`).
- Add a `--sync-upstream` helper flag to `scripts/local-relay-setup.sh`.
- Provide a Docker-based dev environment.
